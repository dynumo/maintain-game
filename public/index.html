<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#00ff00" />
    <meta name="description" content="Maintain eye contact, smile, and liveness under silent judgment." />
    <title>MAINTAIN — Behavioural Compliance Assessment</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <a href="#startBtn" class="skip-link">Skip to main content</a>
    <main class="screen" role="main">
      <header class="header" role="banner">
        <h1>MAINTAIN</h1>
        <p class="subtitle">Behavioural Compliance Assessment</p>
        <p class="meta" aria-live="polite">MANDATORY | SESSION ACTIVE</p>
      </header>

      <div class="main-content">
        <!-- Left: Video Area -->
        <section class="panel video-panel" aria-label="Video feed and game area">
          <div class="video-area" role="img" aria-label="Webcam video feed with face tracking overlay">
            <video id="video" autoplay playsinline muted aria-hidden="true"></video>
            <canvas id="overlay" aria-hidden="true"></canvas>
            <!-- TV noise overlay for idle state -->
            <canvas id="noiseCanvas" class="noise-canvas hidden" aria-hidden="true"></canvas>
            <!-- Scan lines overlay -->
            <div id="scanLines" class="scan-lines hidden" aria-hidden="true"></div>
            <!-- Smile feedback overlay -->
            <div id="smileFeedback" class="smile-feedback hidden" role="alert" aria-live="polite"></div>
            <div id="status" class="status" role="status" aria-live="polite">Idle</div>
            <div id="notice" class="notice hidden" role="alert" aria-live="assertive"></div>
            <div id="badge" class="badge hidden" aria-hidden="true">!</div>
            <div id="veil" class="veil hidden" aria-hidden="true"></div>
            <div id="cursor" class="cursor hidden" aria-hidden="true"></div>
            <!-- Loading overlay -->
            <div id="loadingOverlay" class="loading-overlay hidden" role="dialog" aria-label="Loading">
              <div class="loading-content">
                <div id="loadingText" class="loading-text" aria-live="polite">Initializing...</div>
                <div id="countdownDisplay" class="countdown-display hidden" aria-live="assertive">3</div>
              </div>
            </div>
          </div>
          <p class="privacy">
            Webcam processing occurs entirely in your browser. No data is uploaded.
          </p>
        </section>

        <!-- Right: Sidebar -->
        <aside class="sidebar" role="complementary" aria-label="Game controls and leaderboard">
          <div class="sidebar-section">
            <div id="timer" class="timer" role="timer" aria-label="Elapsed time">00:00.000</div>
            <button id="startBtn" aria-describedby="startHelp">Begin Assessment [Space]</button>
            <span id="startHelp" class="sr-only">Press Space or click to start the assessment</span>
          </div>

          <div class="sidebar-section instructions" role="region" aria-label="Instructions">
            <h2>Protocol</h2>
            <ul>
              <li>Eyes in zone. Expression appropriate. Expectations may change.</li>
            </ul>
          </div>

          <div id="prompt" class="prompt" role="status" aria-live="polite"></div>

          <!-- Debug tracking values -->
          <div id="debugPanel" class="debug-panel hidden" role="region" aria-label="Tracking metrics">
            <h3>Tracking</h3>
            <div id="debugValues" class="debug-values"></div>
          </div>

          <!-- Media controls - music controls hidden until music file detected -->
          <div id="mediaControls" class="sidebar-section media-controls" role="group" aria-label="Media controls">
            <button id="fullscreenBtn" class="media-btn" title="Toggle Fullscreen" aria-label="Toggle fullscreen mode" tabindex="0">⛶</button>
            <button id="musicToggle" class="media-btn music-control hidden" title="Play Music" aria-label="Toggle background music" aria-pressed="false" tabindex="0">♪</button>
            <input type="range" id="volumeSlider" class="volume-slider music-control hidden" min="0" max="1" step="0.1" value="0.3" aria-label="Music volume" title="Volume" />
          </div>

          <div class="sidebar-section leaderboard" role="region" aria-label="Leaderboard">
            <div class="score-entry hidden" id="scoreEntry">
              <label for="playerName">Subject Identifier</label>
              <input id="playerName" maxlength="24" placeholder="SUBJECT" aria-describedby="nameHelp" />
              <span id="nameHelp" class="sr-only">Enter your name (2-24 characters)</span>
              <button id="submitScore">Submit Record</button>
            </div>
            <h2>Compliance Leaderboard</h2>
            <div class="scores-container">
              <ol id="scores" role="list" aria-label="Top scores"></ol>
            </div>
          </div>
        </aside>
      </div>

      <footer class="site-footer">
        A 2026 Global Game Jam project by <a href="https://www.adammcbride.co.uk/" target="_blank" rel="noopener">Adam McBride</a> at <a href="https://www.farsetlabs.org.uk/" target="_blank" rel="noopener">Farset Labs</a>.
      </footer>

    </main>

    <!-- MediaPipe face mesh (peer dependency for mediapipe runtime) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <!-- TensorFlow.js core and backend -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.22.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.22.0"></script>
    <!-- Face landmarks detection model -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.6"></script>
    <script src="main.js"></script>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
              console.log('Service Worker registered successfully:', registration.scope);
            })
            .catch((error) => {
              console.log('Service Worker registration failed:', error);
            });
        });
      }
    </script>
  </body>
</html>
